generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                   String         @id @default(cuid())
  name                 String?
  email                String?        @unique
  emailVerified        DateTime?
  password             String?
  image                String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  discord_username     String?
  embark_id            String?        @unique
  username             String?        @unique
  sessionVersion       Int            @default(0)
  role                 UserRole       @default(USER)
  banReason            String?
  banned               Boolean        @default(false)
  bannedAt             DateTime?
  lastActivityAt       DateTime?
  lastLoginAt          DateTime?
  loginCount           Int            @default(0)
  accounts             Account[]
  targetedActivityLogs ActivityLog[]  @relation("ActivityLogTarget")
  activityLogs         ActivityLog[]  @relation("ActivityLogUser")
  blogs                Blog[]         @relation("BlogAuthor")
  blogComments         BlogComment[]  @relation("BlogCommentAuthor")
  chatsAsParticipant1  Chat[]         @relation("ChatParticipant1")
  chatsAsParticipant2  Chat[]         @relation("ChatParticipant2")
  comments             Comment[]
  guides               Guide[]        @relation("GuideAuthor")
  listings             Listing[]
  loadouts             Loadout[]      @relation("UserLoadouts")
  mapAreaLabels        MapAreaLabel[] @relation("MapAreaLabelCreator")
  mapMarkers           MapMarker[]    @relation("MapMarkerCreator")
  mapRegions           MapRegion[]    @relation("MapRegionCreator")
  mapRoutes            MapRoute[]     @relation("UserRoutes")
  messages             Message[]
  notifications        Notification[] @relation("UserNotifications")
  ratingsGiven         Rating[]       @relation("RatingsGiven")
  ratingsReceived      Rating[]       @relation("RatingsReceived")
  sessions             Session[]
  tradesAsBuyer        Trade[]        @relation("BuyerTrades")
  tradesAsSeller       Trade[]        @relation("SellerTrades")

  @@index([lastActivityAt])
  @@index([lastLoginAt])
  @@index([email, banned])
  @@index([role])
  @@index([banned])
  @@index([createdAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model EmailVerificationToken {
  id           String   @id @default(cuid())
  email        String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  resendCount  Int      @default(0)
  lastResentAt DateTime?

  @@index([email])
  @@index([token])
}

model Item {
  id                  String        @id @default(cuid())
  name                String
  description         String
  item_type           ItemType?
  loadout_slots       String[]      @default([])
  icon                String?
  rarity              Rarity?
  value               Int           @default(0)
  workbench           Workbench?
  stat_block          Json          @default("{}")
  flavor_text         String
  subcategory         String?
  shield_type         String?
  loot_area           LootArea?
  sources             Json?
  ammo_type           AmmoType?
  locations           String[]      @default([])
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  arcLoot             ArcLoot[]     @relation("ArcLootItems")
  comments            Comment[]
  listings            Listing[]
  listingPaymentItems ListingItem[] @relation("ListingPaymentItems")

  @@index([item_type])
  @@index([rarity])
  @@index([workbench])
  @@index([loot_area])
  @@index([item_type, rarity])
  @@index([workbench, item_type])
  @@index([name])
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  itemId     String
  userId     String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([userId])
  @@index([created_at])
}

model Listing {
  id                 String        @id @default(cuid())
  type               ListingType
  status             ListingStatus @default(ACTIVE)
  userId             String
  itemId             String
  quantity           Int
  paymentType        PaymentType
  seedsAmount        Int?
  description        String
  created_at         DateTime      @default(now())
  updated_at         DateTime      @updatedAt
  activeTraderChatId String?       // ID of the chat where trade is in progress
  activeTraderUserId String?       // ID of the user owner selected to trade with
  chats              Chat[]
  item               Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentItems       ListingItem[]
  trades             Trade[]

  @@index([userId])
  @@index([itemId])
  @@index([type])
  @@index([status])
  @@index([created_at])
  @@index([status, created_at])
  @@index([type, status])
  @@index([activeTraderChatId])
}

model ListingItem {
  id         String   @id @default(cuid())
  listingId  String
  itemId     String
  quantity   Int
  created_at DateTime @default(now())
  item       Item     @relation("ListingPaymentItems", fields: [itemId], references: [id], onDelete: Cascade)
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([itemId])
  @@index([listingId, itemId])
}

model Trade {
  id         String      @id @default(cuid())
  listingId  String
  buyerId    String
  sellerId   String
  status     TradeStatus @default(PENDING)
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  rating     Rating?
  buyer      User        @relation("BuyerTrades", fields: [buyerId], references: [id], onDelete: Cascade)
  listing    Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  seller     User        @relation("SellerTrades", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Rating {
  id         String   @id @default(cuid())
  tradeId    String   @unique
  fromUserId String
  toUserId   String
  score      Int
  honest     Boolean
  comment    String?
  created_at DateTime @default(now())
  fromUser   User     @relation("RatingsGiven", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("RatingsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  trade      Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([fromUserId])
  @@index([toUserId])
  @@index([tradeId])
  @@index([toUserId, honest])
}

model Chat {
  id                   String     @id @default(cuid())
  listingId            String
  participant1Id       String
  participant2Id       String
  created_at           DateTime   @default(now())
  updated_at           DateTime   @updatedAt
  participant1Approved Boolean    @default(false)
  participant2Approved Boolean    @default(false)
  status               ChatStatus @default(ACTIVE)
  participant1LockedIn Boolean    @default(false)
  participant2LockedIn Boolean    @default(false)
  listing              Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  participant1         User       @relation("ChatParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2         User       @relation("ChatParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages             Message[]

  @@unique([listingId, participant1Id, participant2Id])
  @@index([listingId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([status])
  @@index([participant1Id, status])
  @@index([participant2Id, status])
  @@index([listingId, status])
}

model Message {
  id         String   @id @default(cuid())
  chatId     String
  senderId   String
  content    String
  read       Boolean  @default(false)
  created_at DateTime @default(now())
  chat       Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@index([created_at])
  @@index([chatId, created_at])
}

model Arc {
  id          String    @id
  name        String
  description String
  icon        String?
  image       String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  loot        ArcLoot[]

  @@index([name])
}

model ArcLoot {
  id         String   @id @default(cuid())
  arcId      String
  itemId     String
  created_at DateTime @default(now())
  arc        Arc      @relation(fields: [arcId], references: [id], onDelete: Cascade)
  item       Item     @relation("ArcLootItems", fields: [itemId], references: [id], onDelete: Cascade)

  @@index([arcId])
  @@index([itemId])
}

model Quest {
  id              String        @id
  name            String
  objectives      String[]
  xp              Int           @default(0)
  granted_items   Json          @default("[]")
  marker_category String?
  image           String?
  required_items  Json          @default("[]")
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  locations       Json          @default("[]")
  guide_links     Json          @default("[]")
  rewards         QuestReward[]

  @@index([name])
}

model QuestReward {
  id         String   @id @default(cuid())
  questId    String
  itemId     String
  quantity   Int
  created_at DateTime @default(now())
  quest      Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@index([questId])
  @@index([itemId])
}

model WorkbenchPlanner {
  id          String                  @id @default(cuid())
  name        String                  @unique
  description String?
  type        Workbench
  created_at  DateTime                @default(now())
  updated_at  DateTime                @updatedAt
  levels      WorkbenchPlannerLevel[]

  @@index([name])
  @@index([type])
}

model WorkbenchPlannerLevel {
  id           String                        @id @default(cuid())
  workbenchId  String
  level        Int
  levelName    String?
  rates        String?
  created_at   DateTime                      @default(now())
  updated_at   DateTime                      @updatedAt
  crafts       WorkbenchPlannerCraft[]
  workbench    WorkbenchPlanner              @relation(fields: [workbenchId], references: [id], onDelete: Cascade)
  requirements WorkbenchPlannerRequirement[]

  @@unique([workbenchId, level])
  @@index([workbenchId])
  @@index([level])
}

model WorkbenchPlannerRequirement {
  id               String                @id @default(cuid())
  workbenchLevelId String
  itemName         String
  quantity         Int
  created_at       DateTime              @default(now())
  workbenchLevel   WorkbenchPlannerLevel @relation(fields: [workbenchLevelId], references: [id], onDelete: Cascade)

  @@index([workbenchLevelId])
  @@index([itemName])
}

model WorkbenchPlannerCraft {
  id               String                @id @default(cuid())
  workbenchLevelId String
  itemName         String
  created_at       DateTime              @default(now())
  workbenchLevel   WorkbenchPlannerLevel @relation(fields: [workbenchLevelId], references: [id], onDelete: Cascade)

  @@index([workbenchLevelId])
  @@index([itemName])
}

model BlueprintLocationVote {
  id           String       @id @default(cuid())
  blueprintId  String
  locationName String
  category     VoteCategory
  userIp       String
  created_at   DateTime     @default(now())

  @@unique([blueprintId, locationName, userIp])
  @@index([blueprintId])
  @@index([blueprintId, category])
  @@index([locationName])
}

model MapMarker {
  id                 String   @id @default(uuid())
  lat                Float
  lng                Float
  zlayers            Int      @default(2147483647)
  mapID              String
  category           String
  subcategory        String?
  instanceName       String?
  behindLockedDoor   Boolean  @default(false)
  eventConditionMask Int      @default(1)
  lootAreas          Json?
  addedByUserId      String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  addedBy            User?    @relation("MapMarkerCreator", fields: [addedByUserId], references: [id])

  @@index([mapID])
  @@index([category])
  @@index([subcategory])
  @@index([addedByUserId])
}

model MapAreaLabel {
  id            String   @id @default(uuid())
  mapID         String
  name          String
  nameAr        String
  lat           Float
  lng           Float
  fontSize      Int      @default(14)
  color         String   @default("#ffffff")
  addedByUserId String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  zlayers       Int      @default(2147483647)
  addedBy       User?    @relation("MapAreaLabelCreator", fields: [addedByUserId], references: [id])

  @@index([mapID])
  @@index([zlayers])
  @@index([addedByUserId])
}

model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  blogs       Blog[]

  @@index([slug])
}

model Blog {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  content       String
  excerpt       String?
  featuredImage String?
  published     Boolean       @default(false)
  viewCount     Int           @default(0)
  publishedAt   DateTime?
  authorId      String
  categoryId    String?
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt
  author        User          @relation("BlogAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  category      BlogCategory? @relation(fields: [categoryId], references: [id])
  comments      BlogComment[]
  tags          BlogTag[]

  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([published])
  @@index([created_at])
  @@index([publishedAt])
}

model BlogComment {
  id         String        @id @default(cuid())
  content    String
  blogId     String
  userId     String
  parentId   String?
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt
  blog       Blog          @relation(fields: [blogId], references: [id], onDelete: Cascade)
  parent     BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    BlogComment[] @relation("CommentReplies")
  user       User          @relation("BlogCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  @@index([blogId])
  @@index([userId])
  @@index([parentId])
  @@index([created_at])
}

model BlogTag {
  id         String   @id @default(cuid())
  blogId     String
  tag        String
  created_at DateTime @default(now())
  blog       Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)

  @@unique([blogId, tag])
  @@index([blogId])
  @@index([tag])
}

model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  title      String
  message    String
  read       Boolean          @default(false)
  link       String?
  metadata   Json?            @default("{}")
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  user       User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([created_at])
}

model GuideCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  guides      Guide[]

  @@index([slug])
}

model Guide {
  id            String         @id @default(cuid())
  title         String
  slug          String         @unique
  content       String
  description   String?
  featuredImage String?
  published     Boolean        @default(false)
  viewCount     Int            @default(0)
  publishedAt   DateTime?
  authorId      String
  categoryId    String?
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  author        User           @relation("GuideAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  category      GuideCategory? @relation(fields: [categoryId], references: [id])
  tags          GuideTag[]

  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([published])
  @@index([created_at])
  @@index([publishedAt])
}

model GuideTag {
  id         String   @id @default(cuid())
  guideId    String
  tag        String
  created_at DateTime @default(now())
  guide      Guide    @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@unique([guideId, tag])
  @@index([guideId])
  @@index([tag])
}

model Loadout {
  id          String   @id @default(cuid())
  uuid        String?  @unique
  name        String
  description String?
  tags        String[] @default([])
  is_public   Boolean  @default(true)
  userId      String?
  profileData Json?
  loadoutData Json
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User?    @relation("UserLoadouts", fields: [userId], references: [id])

  @@index([userId])
  @@index([is_public])
  @@index([created_at])
  @@index([name])
}

model ActivityLog {
  id                String       @id @default(cuid())
  type              ActivityType
  action            String
  actionAr          String
  userId            String?
  targetUserId      String?
  relatedEntityId   String?
  relatedEntityType String?
  metadata          Json?        @default("{}")
  ipAddress         String?
  userAgent         String?
  created_at        DateTime     @default(now())
  targetUser        User?        @relation("ActivityLogTarget", fields: [targetUserId], references: [id])
  user              User?        @relation("ActivityLogUser", fields: [userId], references: [id])

  @@index([userId])
  @@index([targetUserId])
  @@index([type])
  @@index([created_at])
  @@index([relatedEntityType, relatedEntityId])
}

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)
  newListings     Int      @default(0)
  completedTrades Int      @default(0)
  totalMessages   Int      @default(0)
  newGuides       Int      @default(0)
  newMapMarkers   Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([date])
}

model MapConfiguration {
  id         String   @id @default(cuid())
  mapID      String   @unique
  centerLat  Float
  centerLng  Float
  zoom       Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([mapID])
}

model MapRegion {
  id            String   @id @default(uuid())
  mapID         String
  name          String
  nameAr        String?
  description   String?
  coordinates   Json
  fillColor     String   @default("#ff0000")
  fillOpacity   Float    @default(0.3)
  strokeColor   String   @default("#ff0000")
  strokeWeight  Int      @default(2)
  addedByUserId String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  addedBy       User?    @relation("MapRegionCreator", fields: [addedByUserId], references: [id])

  @@index([mapID])
  @@index([addedByUserId])
}

model MapRoute {
  id          String   @id @default(uuid())
  userId      String
  mapID       String
  routeNumber Int
  name        String?
  nameAr      String?
  coordinates Json
  color       String
  visible     Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User     @relation("UserRoutes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mapID, routeNumber])
  @@index([userId, mapID])
  @@index([userId, mapID, visible])
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum WeaponCategory {
  ASSAULT_RIFLE
  BATTLE_RIFLE
  LIGHT_MACHINE_GUN
  PISTOL
  SHOTGUN
  SMG
  SNIPER_RIFLE
  SPECIAL_WEAPON
}

enum CoinType {
  COIN
  RAIDER_TOKEN
}

enum ItemType {
  ADVANCED_MATERIAL
  AMMUNITION
  AUGMENT
  BASIC_MATERIAL
  BLUEPRINT
  CONSUMABLE
  COSMETIC
  GADGET
  KEY
  MATERIAL
  MEDICAL
  MISC
  MODIFICATION
  MODS
  NATURE
  QUEST_ITEM
  QUICK_USE
  RECYCLABLE
  REFINED_MATERIAL
  REFINEMENT
  SHIELD
  THROWABLE
  TOPSIDE_MATERIAL
  TRINKET
  WEAPON
}

enum Workbench {
  SCRAPPY
  GUNSMITH
  GEAR_BENCH
  MEDICAL_LAB
  EXPLOSIVES_STATION
  UTILITY_STATION
  REFINER
  WORKBENCH
}

enum LootArea {
  ARC
  COMMERCIAL
  MEDICAL
  RESIDENTIAL
  ELECTRICAL
  TECHNOLOGICAL
  EXODUS
  INDUSTRIAL
  MECHANICAL
  NATURE
  OLD_WORLD
  RAIDER
  SECURITY
}

enum AmmoType {
  SHOTGUN
  ENERGY
  HEAVY
  LAUNCHER
  LIGHT
  MEDIUM
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum ActivityType {
  USER_REGISTERED
  USER_LOGIN
  USER_BANNED
  USER_UNBANNED
  LISTING_CREATED
  LISTING_UPDATED
  LISTING_DELETED
  TRADE_COMPLETED
  CHAT_STARTED
  GUIDE_CREATED
  GUIDE_UPDATED
  GUIDE_DELETED
  MAP_MARKER_ADDED
  MAP_MARKER_DELETED
  ITEM_CREATED
  ITEM_UPDATED
  ADMIN_ACTION
  SYSTEM_EVENT
}

enum ListingType {
  WTS
  WTB
}

enum ListingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentType {
  SEEDS
  ITEMS
  OPEN_OFFERS
}

enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum ChatStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  OWNER_TRADING    // Owner is trading with another user (waiting in queue)
}

enum VoteCategory {
  CONTAINERS
  MAPS
  EVENTS
}

enum NotificationType {
  BLOG_COMMENT
  BLOG_COMMENT_REPLY
  CHAT_MESSAGE
}

// Site Settings for Admin Configuration
model SiteSetting {
  id            String           @id @default(cuid())
  key           String           @unique
  value         String
  valueType     SettingValueType @default(STRING)
  category      SettingCategory
  label         String
  labelAr       String
  description   String?
  descriptionAr String?
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  @@index([category])
  @@index([key])
}

enum SettingValueType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum SettingCategory {
  GENERAL
  FEATURES
  SECURITY
  SYSTEM
}
