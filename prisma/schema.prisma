// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum WeaponCategory {
  ASSAULT_RIFLE
  BATTLE_RIFLE
  LIGHT_MACHINE_GUN
  PISTOL
  SHOTGUN
  SMG
  SNIPER_RIFLE
  SPECIAL_WEAPON
}

enum CoinType {
  COIN
  RAIDER_TOKEN
}

enum ItemType {
  ADVANCED_MATERIAL
  AMMUNITION
  AUGMENT
  BASIC_MATERIAL
  BLUEPRINT
  CONSUMABLE
  COSMETIC
  GADGET
  KEY
  MATERIAL
  MEDICAL
  MISC
  MODIFICATION
  MODS
  NATURE
  QUEST_ITEM
  QUICK_USE
  RECYCLABLE
  REFINED_MATERIAL
  REFINEMENT
  SHIELD
  THROWABLE
  TOPSIDE_MATERIAL
  TRINKET
  WEAPON
}

enum Workbench {
  WORKBENCH
  SCRAPPY
  GUNSMITH
  GEAR_BENCH
  MEDICAL_LAB
  EXPLOSIVES_STATION
  UTILITY_STATION
  REFINER
}

enum LootArea {
  ARC
  COMMERCIAL
  MEDICAL
  RESIDENTIAL
  ELECTRICAL
  TECHNOLOGICAL
  EXODUS
  INDUSTRIAL
  MECHANICAL
  NATURE
  OLD_WORLD
  RAIDER
  SECURITY
}

enum AmmoType {
  SHOTGUN
  ENERGY
  HEAVY
  LAUNCHER
  LIGHT
  MEDIUM
}

enum UserRole {
  USER
  ADMIN
}

enum ActivityType {
  USER_REGISTERED
  USER_LOGIN
  USER_BANNED
  USER_UNBANNED
  LISTING_CREATED
  LISTING_UPDATED
  LISTING_DELETED
  TRADE_COMPLETED
  CHAT_STARTED
  GUIDE_CREATED
  GUIDE_UPDATED
  GUIDE_DELETED
  MAP_MARKER_ADDED
  MAP_MARKER_DELETED
  ITEM_CREATED
  ITEM_UPDATED
  ADMIN_ACTION
  SYSTEM_EVENT
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                String    @id @default(cuid())
  role              UserRole  @default(USER)
  banned            Boolean   @default(false)
  bannedAt          DateTime?
  banReason         String?   @db.Text
  username          String?   @unique
  name              String?
  email             String?   @unique
  emailVerified     DateTime?
  password          String?
  image             String?
  embark_id         String?
  discord_username  String?
  sessionVersion    Int       @default(0)

  // Activity tracking fields
  lastLoginAt       DateTime?
  loginCount        Int       @default(0)
  lastActivityAt    DateTime?

  accounts          Account[]
  sessions          Session[]
  comments          Comment[]
  listings          Listing[]
  tradesAsBuyer     Trade[]   @relation("BuyerTrades")
  tradesAsSeller    Trade[]   @relation("SellerTrades")
  ratingsGiven      Rating[]  @relation("RatingsGiven")
  ratingsReceived   Rating[]  @relation("RatingsReceived")
  chatsAsParticipant1 Chat[]  @relation("ChatParticipant1")
  chatsAsParticipant2 Chat[]  @relation("ChatParticipant2")
  messages          Message[]
  blogs             Blog[]         @relation("BlogAuthor")
  blogComments      BlogComment[]  @relation("BlogCommentAuthor")
  guides            Guide[]        @relation("GuideAuthor")
  notifications     Notification[] @relation("UserNotifications")
  mapMarkers        MapMarker[]    @relation("MapMarkerCreator")
  mapAreaLabels     MapAreaLabel[] @relation("MapAreaLabelCreator")
  loadouts          Loadout[]      @relation("UserLoadouts")

  // Activity log relations
  activityLogs        ActivityLog[] @relation("ActivityLogUser")
  targetedActivityLogs ActivityLog[] @relation("ActivityLogTarget")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([lastActivityAt])
  @@index([lastLoginAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Item {
  id                   String        @id @default(cuid())
  name                 String
  description          String        @db.Text
  item_type            ItemType?
  loadout_slots        String[]      @default([])
  icon                 String?
  rarity               Rarity?
  value                Int           @default(0)
  workbench            Workbench?
  stat_block           Json          @default("{}")
  flavor_text          String        @db.Text
  subcategory          String?
  shield_type          String?
  loot_area            LootArea?
  sources              Json?
  ammo_type            AmmoType?
  locations            String[]      @default([])
  comments             Comment[]
  listings             Listing[]
  listingPaymentItems  ListingItem[] @relation("ListingPaymentItems")
  arcLoot              ArcLoot[]     @relation("ArcLootItems")
  created_at           DateTime      @default(now())
  updated_at           DateTime      @updatedAt

  @@index([item_type])
  @@index([rarity])
  @@index([workbench])
  @@index([loot_area])
}

model Comment {
  id         String   @id @default(cuid())
  content    String   @db.Text
  itemId     String
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([itemId])
  @@index([userId])
  @@index([created_at])
}

enum ListingType {
  WTS // Want to Sell
  WTB // Want to Buy
}

enum ListingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PaymentType {
  SEEDS
  ITEMS
  OPEN_OFFERS
}

model Listing {
  id            String        @id @default(cuid())
  type          ListingType
  status        ListingStatus @default(ACTIVE)
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Main item being sold/bought
  itemId        String
  item          Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  quantity      Int

  // Payment preference
  paymentType   PaymentType
  seedsAmount   Int?          // For SEEDS payment type
  description   String        @db.Text

  // Related items for ITEMS payment type
  paymentItems  ListingItem[]

  trades        Trade[]
  chats         Chat[]
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt

  @@index([userId])
  @@index([itemId])
  @@index([type])
  @@index([status])
  @@index([created_at])
}

model ListingItem {
  id         String   @id @default(cuid())
  listingId  String
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  itemId     String
  item       Item     @relation("ListingPaymentItems", fields: [itemId], references: [id], onDelete: Cascade)
  quantity   Int
  created_at DateTime @default(now())

  @@index([listingId])
  @@index([itemId])
}

enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

model Trade {
  id         String      @id @default(cuid())
  listingId  String
  listing    Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerId    String
  buyer      User        @relation("BuyerTrades", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerId   String
  seller     User        @relation("SellerTrades", fields: [sellerId], references: [id], onDelete: Cascade)
  status     TradeStatus @default(PENDING)
  rating     Rating?
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

model Rating {
  id         String   @id @default(cuid())
  tradeId    String   @unique
  trade      Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  fromUserId String
  fromUser   User     @relation("RatingsGiven", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUserId   String
  toUser     User     @relation("RatingsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  score      Int      // 1-5 stars
  honest     Boolean  // Was the trader honest?
  comment    String?  @db.Text
  created_at DateTime @default(now())

  @@index([fromUserId])
  @@index([toUserId])
  @@index([tradeId])
}

enum ChatStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Chat {
  id                    String     @id @default(cuid())
  listingId             String
  listing               Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)

  // Two participants in the chat
  participant1Id        String
  participant1          User       @relation("ChatParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2Id        String
  participant2          User       @relation("ChatParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)

  // Lock-in tracking (must lock in before seeing embark IDs)
  participant1LockedIn  Boolean    @default(false)
  participant2LockedIn  Boolean    @default(false)

  // Trade approval tracking (happens after lock-in)
  participant1Approved  Boolean    @default(false)
  participant2Approved  Boolean    @default(false)
  status                ChatStatus @default(ACTIVE)

  messages              Message[]
  created_at            DateTime   @default(now())
  updated_at            DateTime   @updatedAt

  @@unique([listingId, participant1Id, participant2Id])
  @@index([listingId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([status])
}

model Message {
  id         String   @id @default(cuid())
  chatId     String
  chat       Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  senderId   String
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content    String   @db.Text
  read       Boolean  @default(false)
  created_at DateTime @default(now())

  @@index([chatId])
  @@index([senderId])
  @@index([created_at])
}

model Arc {
  id          String     @id
  name        String
  description String     @db.Text
  icon        String?
  image       String?
  loot        ArcLoot[]
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  @@index([name])
}

model ArcLoot {
  id         String   @id @default(cuid())
  arcId      String
  arc        Arc      @relation(fields: [arcId], references: [id], onDelete: Cascade)
  itemId     String
  item       Item     @relation("ArcLootItems", fields: [itemId], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())

  @@index([arcId])
  @@index([itemId])
}

model Quest {
  id              String        @id
  name            String
  objectives      String[]
  xp              Int           @default(0)
  granted_items   Json          @default("[]")
  locations       Json          @default("[]")
  marker_category String?
  image           String?
  guide_links     Json          @default("[]")
  required_items  Json          @default("[]")
  rewards         QuestReward[]
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  @@index([name])
}

model QuestReward {
  id         String   @id @default(cuid())
  questId    String
  quest      Quest    @relation(fields: [questId], references: [id], onDelete: Cascade)
  itemId     String
  quantity   Int
  created_at DateTime @default(now())

  @@index([questId])
  @@index([itemId])
}

// Workbench Planner Models
model WorkbenchPlanner {
  id          String                  @id @default(cuid())
  name        String                  @unique
  description String?                 @db.Text
  type        Workbench
  levels      WorkbenchPlannerLevel[]
  created_at  DateTime                @default(now())
  updated_at  DateTime                @updatedAt

  @@index([name])
  @@index([type])
}

model WorkbenchPlannerLevel {
  id                String                        @id @default(cuid())
  workbenchId       String
  workbench         WorkbenchPlanner              @relation(fields: [workbenchId], references: [id], onDelete: Cascade)
  level             Int
  levelName         String?                       // For Scrappy levels like "1 - Fledgling"
  rates             String?                       // For Scrappy passive rates
  requirements      WorkbenchPlannerRequirement[]
  crafts            WorkbenchPlannerCraft[]
  created_at        DateTime                      @default(now())
  updated_at        DateTime                      @updatedAt

  @@unique([workbenchId, level])
  @@index([workbenchId])
  @@index([level])
}

model WorkbenchPlannerRequirement {
  id                String                @id @default(cuid())
  workbenchLevelId  String
  workbenchLevel    WorkbenchPlannerLevel @relation(fields: [workbenchLevelId], references: [id], onDelete: Cascade)
  itemName          String                // Item name as it appears in items table
  quantity          Int
  created_at        DateTime              @default(now())

  @@index([workbenchLevelId])
  @@index([itemName])
}

model WorkbenchPlannerCraft {
  id                String                @id @default(cuid())
  workbenchLevelId  String
  workbenchLevel    WorkbenchPlannerLevel @relation(fields: [workbenchLevelId], references: [id], onDelete: Cascade)
  itemName          String                // Item name as it appears in items table
  created_at        DateTime              @default(now())

  @@index([workbenchLevelId])
  @@index([itemName])
}

enum VoteCategory {
  CONTAINERS
  MAPS
  EVENTS
}

model BlueprintLocationVote {
  id           String        @id @default(cuid())
  blueprintId  String
  locationName String        // e.g., "Stella Montis", "Ammo Crate", "Cold Snap"
  category     VoteCategory
  userIp       String        // Anonymous tracking by IP address
  created_at   DateTime      @default(now())

  @@unique([blueprintId, locationName, userIp])
  @@index([blueprintId])
  @@index([blueprintId, category])
  @@index([locationName])
}

// Map Markers Model
model MapMarker {
  id                  String   @id @default(uuid())
  lat                 Float
  lng                 Float
  zlayers             Int      @default(2147483647)
  mapID               String
  category            String
  subcategory         String?
  instanceName        String?
  behindLockedDoor    Boolean  @default(false)
  eventConditionMask  Int      @default(1)
  lootAreas           Json?
  addedByUserId       String?
  addedBy             User?    @relation("MapMarkerCreator", fields: [addedByUserId], references: [id], onDelete: SetNull)
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  @@index([mapID])
  @@index([category])
  @@index([subcategory])
  @@index([addedByUserId])
}

model MapAreaLabel {
  id              String   @id @default(uuid())
  mapID           String
  name            String
  nameAr          String
  lat             Float
  lng             Float
  fontSize        Int      @default(14)
  color           String   @default("#ffffff")
  addedByUserId   String?
  addedBy         User?    @relation("MapAreaLabelCreator", fields: [addedByUserId], references: [id], onDelete: SetNull)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([mapID])
  @@index([addedByUserId])
}

// Blog System Models
model BlogCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  icon        String?  // Lucide icon name
  color       String?  // Hex color for badge
  blogs       Blog[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([slug])
}

model Blog {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  content         String        @db.Text  // HTML content from rich text editor
  excerpt         String?       @db.Text  // Short description
  featuredImage   String?                 // MinIO URL for cover image
  published       Boolean       @default(false)
  viewCount       Int           @default(0)
  publishedAt     DateTime?                // When first published

  // Author relationship
  authorId        String
  author          User          @relation("BlogAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  // Category relationship
  categoryId      String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Relations
  comments        BlogComment[]
  tags            BlogTag[]

  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([published])
  @@index([created_at])
  @@index([publishedAt])
}

model BlogComment {
  id         String        @id @default(cuid())
  content    String        @db.Text

  // Blog relationship
  blogId     String
  blog       Blog          @relation(fields: [blogId], references: [id], onDelete: Cascade)

  // Author relationship
  userId     String
  user       User          @relation("BlogCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)

  // Self-referencing for nested comments
  parentId   String?
  parent     BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    BlogComment[] @relation("CommentReplies")

  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt

  @@index([blogId])
  @@index([userId])
  @@index([parentId])
  @@index([created_at])
}

model BlogTag {
  id      String @id @default(cuid())
  blogId  String
  blog    Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)
  tag     String

  created_at DateTime @default(now())

  @@unique([blogId, tag])
  @@index([blogId])
  @@index([tag])
}

// Notification System
enum NotificationType {
  BLOG_COMMENT          // Someone commented on your blog
  BLOG_COMMENT_REPLY    // Someone replied to your comment
  CHAT_MESSAGE          // Someone sent you a chat message
}

model Notification {
  id          String           @id @default(cuid())

  // User who receives this notification
  userId      String
  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  type        NotificationType
  title       String
  message     String           @db.Text
  read        Boolean          @default(false)
  link        String?          // URL to navigate to when clicked

  // Additional data (blogId, commentId, etc.)
  metadata    Json?            @default("{}")

  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  @@index([userId])
  @@index([userId, read])
  @@index([created_at])
}

// Guide System Models
model GuideCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?  @db.Text
  icon        String?  // Lucide icon name
  color       String?  // Hex color for badge
  guides      Guide[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([slug])
}

model Guide {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  content         String         @db.Text  // HTML content from rich text editor
  description     String?        @db.Text  // Short description
  featuredImage   String?                  // MinIO URL for cover image
  published       Boolean        @default(false)
  viewCount       Int            @default(0)
  publishedAt     DateTime?                 // When first published

  // Author relationship
  authorId        String
  author          User           @relation("GuideAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  // Category relationship
  categoryId      String?
  category        GuideCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Relations
  tags            GuideTag[]

  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  @@index([authorId])
  @@index([categoryId])
  @@index([slug])
  @@index([published])
  @@index([created_at])
  @@index([publishedAt])
}

model GuideTag {
  id      String @id @default(cuid())
  guideId String
  guide   Guide  @relation(fields: [guideId], references: [id], onDelete: Cascade)
  tag     String

  created_at DateTime @default(now())

  @@unique([guideId, tag])
  @@index([guideId])
  @@index([tag])
}

// Loadout System Models
model Loadout {
  id            String   @id @default(cuid())
  uuid          String?  @unique // Original UUID from imported data
  name          String
  description   String?  @db.Text
  tags          String[] @default([])
  is_public     Boolean  @default(true)

  // User relationship - nullable for imported data, allows users to create their own later
  userId        String?
  user          User?    @relation("UserLoadouts", fields: [userId], references: [id], onDelete: SetNull)

  // Profile data (for imported loadouts without user accounts)
  profileData   Json?    // Store {id, username, full_name}

  // Complete loadout equipment stored as JSON
  loadoutData   Json     // Contains shield, augment, backpack, quickUse, safePocket, weaponprimary, weaponsecondary

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([userId])
  @@index([is_public])
  @@index([created_at])
  @@index([name])
}

// Activity Logging System
model ActivityLog {
  id                String       @id @default(cuid())
  type              ActivityType
  action            String       // Human-readable action description (English)
  actionAr          String       // Arabic translation

  // User who performed the action (nullable for system events)
  userId            String?
  user              User?        @relation("ActivityLogUser", fields: [userId], references: [id], onDelete: SetNull)

  // Target user (for admin actions on users)
  targetUserId      String?
  targetUser        User?        @relation("ActivityLogTarget", fields: [targetUserId], references: [id], onDelete: SetNull)

  // Related entity IDs for tracking
  relatedEntityId   String?      // Generic ID for listings, guides, markers, etc.
  relatedEntityType String?      // Type: "LISTING", "GUIDE", "MARKER", etc.

  // Additional context
  metadata          Json?        @default("{}")  // Store additional details
  ipAddress         String?
  userAgent         String?

  created_at        DateTime     @default(now())

  @@index([userId])
  @@index([targetUserId])
  @@index([type])
  @@index([created_at])
  @@index([relatedEntityType, relatedEntityId])
}

// Daily Statistics Aggregation (for performance)
model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date

  // User metrics
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)

  // Marketplace metrics
  newListings     Int      @default(0)
  completedTrades Int      @default(0)

  // Chat metrics
  totalMessages   Int      @default(0)

  // Content metrics
  newGuides       Int      @default(0)
  newMapMarkers   Int      @default(0)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([date])
}
