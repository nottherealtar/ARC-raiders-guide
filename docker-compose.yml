services:
  postgres:
    image: postgres:16-alpine
    container_name: arcraiders-postgres
    restart: unless-stopped
    env_file:
      - .env.local
    ports:
      - '5432:5432'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-arcraiders}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - arcraiders-network

  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: arcraiders-pgbouncer
    restart: unless-stopped
    ports:
      - '6432:6432'
    environment:
      DATABASES_HOST: postgres
      DATABASES_PORT: 5432
      DATABASES_USER: ${POSTGRES_USER:-postgres}
      DATABASES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      DATABASES_DBNAME: ${POSTGRES_DB:-arcraiders}
      PGBOUNCER_POOL_MODE: transaction
      PGBOUNCER_MAX_CLIENT_CONN: 1000
      PGBOUNCER_DEFAULT_POOL_SIZE: 25
      PGBOUNCER_MIN_POOL_SIZE: 10
      PGBOUNCER_RESERVE_POOL_SIZE: 5
      PGBOUNCER_SERVER_IDLE_TIMEOUT: 600
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - arcraiders-network

  redis:
    image: redis:7-alpine
    container_name: arcraiders-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - arcraiders-network

  minio:
    image: minio/minio:latest
    container_name: arcraiders-minio
    restart: unless-stopped
    env_file:
      - .env.local
    ports:
      - '9000:9000'  # MinIO API port
      - '9001:9001'  # MinIO Console (Web UI)
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-http://localhost:9001}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'mc', 'ready', 'local']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - arcraiders-network

  migrate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcraiders-migrate
    restart: 'no'  # Run once and exit
    env_file:
      - .env.local
    working_dir: /app
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_started
    entrypoint: []  # Override Dockerfile ENTRYPOINT
    command: >
      sh -c "
        echo 'ðŸ”„ Running database migrations...' &&
        npx prisma migrate deploy &&
        echo 'âœ… Migrations completed successfully!'
      "
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@pgbouncer:6432/${POSTGRES_DB:-arcraiders}?schema=public&pgbouncer=true
    volumes:
      - ./prisma:/app/prisma
    networks:
      - arcraiders-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: arcraiders-app
    restart: unless-stopped
    env_file:
      - .env.local
    working_dir: /app
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_started
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    entrypoint: []  # Override Dockerfile ENTRYPOINT
    command: ['node', 'server.js']
    ports:
      - '80:3001'  # Expose Next.js directly on port 80
      # Or use '3001:3001' if you prefer to access on port 3001
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@pgbouncer:6432/${POSTGRES_DB:-arcraiders}?schema=public&pgbouncer=true
      REDIS_URL: redis://redis:6379
      AUTH_URL: ${AUTH_URL:-http://145.223.116.42}
      AUTH_SECRET: ${AUTH_SECRET}
      AUTH_TRUST_HOST: true
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      PORT: 3001
      HOSTNAME: 0.0.0.0
    volumes:
      - ./prisma:/app/prisma
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3001', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - arcraiders-network

networks:
  arcraiders-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
